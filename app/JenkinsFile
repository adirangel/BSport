
pipeline {
    agent {
        docker { image 'node:7-alpine'         
        }
    }
    
    stages {
        stage('Unit & Integration Tests') {
            steps {
                script {
                    try {
                        sh 'chmod +x gradlew' 
                    } finally {
                        junit '**/build/test-results/test/*.xml'
                    }
                }
            }
        }
        stage('Frontend Unit Tests') {
            steps {
                sshagent(['git']) {
                    script {
                        try {
                            sh './gradlew cleanFrontendTest --no-daemon'
                            sh './gradlew frontendUnitTest --no-daemon'
                        } finally {
                            junit 'publicapi/frontend/test/karma-result.xml'
                        }
                    }
                }
            }
        }
        stage('Frontend Static Code Analysis') {
            steps {
                script {
                    try {
                        sh './gradlew tslint --no-daemon'
                    } finally { 
                        checkstyle canComputeNew: false, defaultEncoding: '', healthy: '', pattern: 'publicapi/frontend/tslint-result.xml', unHealthy: ''
                    }
                }
            }
        }
        stage('End 2 End Tests') {
            steps {
                script {
                    try {
                        sh './gradlew e2e --no-daemon'
                    } finally { 
                        junit '**/e2e-results/junit-formatted/*.xml'
                        publishHTML([allowMissing: false, alwaysLinkToLastBuild: false, keepAll: false, reportDir: 'publicapi/frontend/test/e2e-results/html-formatted/', reportFiles: 'htmlReport.html', reportName: 'End 2 End Test Report', reportTitles: ''])
                    }
                }
            }
        }
        stage('Publish Artifact to Nexus') {
            steps {
                sh './gradlew publish --no-daemon'
            }
        }
    }

    }

